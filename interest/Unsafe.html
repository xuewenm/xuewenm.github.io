<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"xuewenm.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1. Unsafe 类 1.1 获取实例 1.2 常用方法 1.2.1 Class 相关 1.2.2 Object 相关 1.2.3 数组相关 1.2.4 CAS 相关 1.2.5 线程调度相关 1.2.6 volatile 相关读写 1.2.7 内存屏障相关 1.2.8 内存管理（非堆内存） 1.2.9 系统相关 1.2.10 其他   1.3 Unsafe 类的使用场景 1.3.1 避免">
<meta property="og:type" content="website">
<meta property="og:title" content="【Java 并发笔记】Unsafe 相关整理">
<meta property="og:url" content="https://xuewenm.github.io/interest/Unsafe.html">
<meta property="og:site_name" content="Wen&#39;s blog">
<meta property="og:description" content="1. Unsafe 类 1.1 获取实例 1.2 常用方法 1.2.1 Class 相关 1.2.2 Object 相关 1.2.3 数组相关 1.2.4 CAS 相关 1.2.5 线程调度相关 1.2.6 volatile 相关读写 1.2.7 内存屏障相关 1.2.8 内存管理（非堆内存） 1.2.9 系统相关 1.2.10 其他   1.3 Unsafe 类的使用场景 1.3.1 避免">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-04-15T08:03:02.000Z">
<meta property="article:modified_time" content="2023-02-07T12:16:42.526Z">
<meta property="article:author" content="XueWen">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://xuewenm.github.io/interest/Unsafe">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"zh-CN","comments":true,"permalink":"https://xuewenm.github.io/interest/Unsafe.html","path":"interest/Unsafe.html","title":"【Java 并发笔记】Unsafe 相关整理"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【Java 并发笔记】Unsafe 相关整理 | Wen's blog
</title>
  








  <!-- <script type="text/javascript" src="/js/dynamic-bg.js"></script>-->
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wen's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-interest"><a href="/interest/" rel="section"><i class="fa fa-heart fa-fw"></i>interest</a></li><li class="menu-item menu-item-c"><a href="/c/" rel="section"><i class="fa fa-heart fa-fw"></i>C</a></li><li class="menu-item menu-item-python"><a href="/python/" rel="section"><i class="fa fa-heart fa-fw"></i>Python</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E3%80%90Java-%E5%B9%B6%E5%8F%91%E7%AC%94%E8%AE%B0%E3%80%91Unsafe-%E7%9B%B8%E5%85%B3%E6%95%B4%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">【Java 并发笔记】Unsafe 相关整理</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-Unsafe-%E7%B1%BB"><span class="nav-number">2.</span> <span class="nav-text">1. Unsafe 类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E8%8E%B7%E5%8F%96%E5%AE%9E%E4%BE%8B"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 获取实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 常用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-Class-%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.1.</span> <span class="nav-text">1.2.1 Class 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-Object-%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.2.</span> <span class="nav-text">1.2.2 Object 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-%E6%95%B0%E7%BB%84%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.3.</span> <span class="nav-text">1.2.3 数组相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-CAS-%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.4.</span> <span class="nav-text">1.2.4 CAS 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-5-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.5.</span> <span class="nav-text">1.2.5 线程调度相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-6-volatile-%E7%9B%B8%E5%85%B3%E8%AF%BB%E5%86%99"><span class="nav-number">2.2.6.</span> <span class="nav-text">1.2.6 volatile 相关读写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-7-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.7.</span> <span class="nav-text">1.2.7 内存屏障相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-8-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%88%E9%9D%9E%E5%A0%86%E5%86%85%E5%AD%98%EF%BC%89"><span class="nav-number">2.2.8.</span> <span class="nav-text">1.2.8 内存管理（非堆内存）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-9-%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3"><span class="nav-number">2.2.9.</span> <span class="nav-text">1.2.9 系统相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-10-%E5%85%B6%E4%BB%96"><span class="nav-number">2.2.10.</span> <span class="nav-text">1.2.10 其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-Unsafe-%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 Unsafe 类的使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-%E9%81%BF%E5%85%8D%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.3.1.</span> <span class="nav-text">1.3.1 避免初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-2-%E5%86%85%E5%AD%98%E4%BF%AE%E6%94%B9"><span class="nav-number">2.3.2.</span> <span class="nav-text">1.3.2 内存修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-3-%E5%8A%A8%E6%80%81%E7%B1%BB"><span class="nav-number">2.3.3.</span> <span class="nav-text">1.3.3 动态类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-4-%E5%A4%A7%E6%95%B0%E7%BB%84"><span class="nav-number">2.3.4.</span> <span class="nav-text">1.3.4 大数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-5-%E5%B9%B6%E5%8F%91%E5%BA%94%E7%94%A8"><span class="nav-number">2.3.5.</span> <span class="nav-text">1.3.5 并发应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-6-%E6%8C%82%E8%B5%B7%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="nav-number">2.3.6.</span> <span class="nav-text">1.3.6 挂起与恢复</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-6-1-park-%E5%92%8C-unpark-%E7%81%B5%E6%B4%BB%E4%B9%8B%E5%A4%84"><span class="nav-number">2.3.6.1.</span> <span class="nav-text">1.3.6.1 park 和 unpark 灵活之处</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">3.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="XueWen"
      src="/images/ic_hello.png">
  <p class="site-author-name" itemprop="name">XueWen</p>
  <div class="site-description" itemprop="description">不积硅步无以至千里，不积小流何以成江海。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">56</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/guanyuespace" title="Code → https:&#x2F;&#x2F;github.com&#x2F;guanyuespace" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>Code</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/xuewenm" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xuewenm" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1853376164@qq.com" title="Mail → mailto:1853376164@qq.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:guanyue003@gmail.com" title="E-Mail → mailto:guanyue003@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
	  <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=28798308&auto=1&height=66"></iframe>
	  
    </div>

    
  </aside>


    </div>

    <div class="main-inner page posts-expand">


    
    
    
    <div class="post-block" lang="zh-CN"><header class="post-header">

<h1 class="post-title" itemprop="name headline">【Java 并发笔记】Unsafe 相关整理
</h1>

<div class="post-meta-container">
</div>

</header>

      
      
      <div class="post-body">
          <!-- TOC -->

<ul>
<li><a href="#1-unsafe-%E7%B1%BB">1. Unsafe 类</a><ul>
<li><a href="#11-%E8%8E%B7%E5%8F%96%E5%AE%9E%E4%BE%8B">1.1 获取实例</a></li>
<li><a href="#12-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95">1.2 常用方法</a><ul>
<li><a href="#121-class-%E7%9B%B8%E5%85%B3">1.2.1 Class 相关</a></li>
<li><a href="#122-object-%E7%9B%B8%E5%85%B3">1.2.2 Object 相关</a></li>
<li><a href="#123-%E6%95%B0%E7%BB%84%E7%9B%B8%E5%85%B3">1.2.3 数组相关</a></li>
<li><a href="#124-cas-%E7%9B%B8%E5%85%B3">1.2.4 CAS 相关</a></li>
<li><a href="#125-%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%9B%B8%E5%85%B3">1.2.5 线程调度相关</a></li>
<li><a href="#126-volatile-%E7%9B%B8%E5%85%B3%E8%AF%BB%E5%86%99">1.2.6 volatile 相关读写</a></li>
<li><a href="#127-%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E7%9B%B8%E5%85%B3">1.2.7 内存屏障相关</a></li>
<li><a href="#128-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E9%9D%9E%E5%A0%86%E5%86%85%E5%AD%98">1.2.8 内存管理（<em><strong>非堆内存</strong></em>）</a></li>
<li><a href="#129-%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3">1.2.9 系统相关</a></li>
<li><a href="#1210-%E5%85%B6%E4%BB%96">1.2.10 其他</a></li>
</ul>
</li>
<li><a href="#13-unsafe-%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">1.3 Unsafe 类的使用场景</a><ul>
<li><a href="#131-%E9%81%BF%E5%85%8D%E5%88%9D%E5%A7%8B%E5%8C%96">1.3.1 避免初始化</a></li>
<li><a href="#132-%E5%86%85%E5%AD%98%E4%BF%AE%E6%94%B9">1.3.2 内存修改</a></li>
<li><a href="#133-%E5%8A%A8%E6%80%81%E7%B1%BB">1.3.3 动态类</a></li>
<li><a href="#134-%E5%A4%A7%E6%95%B0%E7%BB%84">1.3.4 大数组</a></li>
<li><a href="#135-%E5%B9%B6%E5%8F%91%E5%BA%94%E7%94%A8">1.3.5 并发应用</a></li>
<li><a href="#136-%E6%8C%82%E8%B5%B7%E4%B8%8E%E6%81%A2%E5%A4%8D">1.3.6 <em><strong>挂起与恢复</strong></em></a><ul>
<li><a href="#1361-park-%E5%92%8C-unpark-%E7%81%B5%E6%B4%BB%E4%B9%8B%E5%A4%84">1.3.6.1 park 和 unpark 灵活之处</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="【Java-并发笔记】Unsafe-相关整理"><a href="#【Java-并发笔记】Unsafe-相关整理" class="headerlink" title="【Java 并发笔记】Unsafe 相关整理"></a>【Java 并发笔记】Unsafe 相关整理</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2e5b92d0962e">转自：【Java 并发笔记】Unsafe 相关整理</a></p>
</blockquote>
<h1 id="1-Unsafe-类"><a href="#1-Unsafe-类" class="headerlink" title="1. Unsafe 类"></a>1. Unsafe 类</h1><ul>
<li>Java 不能直接访问操作系统底层，而是通过本地方法来访问。Unsafe 类提供了硬件级别的原子操作。</li>
<li>Unsafe 类在 <strong>sun.misc</strong> 包下，不属于 Java 标准。很多 Java 的基础类库，包括一些被广泛使用的高性能开发库都是基于 Unsafe 类开发，比如 Netty、Hadoop、Kafka 等。<ul>
<li>Unsafe 是用于在实质上扩展 Java 语言表达能力、便于在更高层（Java 层）代码里实现原本要在更低层（C 层）实现的核心库功能用的。</li>
<li>这些功能包括裸内存的申请&#x2F;释放&#x2F;访问，低层硬件的 atomic&#x2F;volatile 支持，创建未初始化对象等。</li>
<li>它原本的设计就只应该被标准库使用，因此不建议在生产环境中使用。</li>
</ul>
</li>
</ul>
<h2 id="1-1-获取实例"><a href="#1-1-获取实例" class="headerlink" title="1.1 获取实例"></a>1.1 获取实例</h2><ul>
<li><p>Unsafe 对象不能直接通过 <strong>new Unsafe()</strong> 或调用 <strong>Unsafe.getUnsafe()</strong> 获取。</p>
<ul>
<li>Unsafe 被设计成单例模式，构造方法私有。</li>
<li>getUnsafe 被设计成只能从引导类加载器（bootstrap class loader）加载。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Unsafe</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">var0</span> <span class="operator">=</span> Reflection.getCallerClass(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (var0.getClassLoader() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unsafe&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> theUnsafe;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>非启动类加载器直接调用 Unsafe.getUnsafe() 方法会抛出 SecurityException 异常。</p>
</li>
<li><p>解决办法有两个:<br>1）可以令代码 “ 受信任 “。运行程序时，通过 JVM 参数设置 bootclasspath 选项，指定系统类路径加上使用的一个 Unsafe 路径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xbootclasspath:/usr/jdk1<span class="number">.7</span><span class="number">.0</span>/jre/lib/rt.jar:. com.mishadoff.magic.UnsafeClient</span><br></pre></td></tr></table></figure>
<p>2）通过 Java 反射机制。</p>
</li>
<li><p>通过将 private 单例实例暴力设置 accessible 为 true，然后通过 Field 的 get 方法，直接获取一个 Object 强制转换为 Unsafe。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">unsafe = (Unsafe) theUnsafe.get(Unsafe.class);<span class="comment">//or (Unsafe) theUnsafe.get(null);</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 IDE 中，这些方法会被标志为 Error，可以通过以下设置解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Preferences -&gt; Java -&gt; Compiler -&gt; Errors/Warnings -&gt; Deprecated and restricted API -&gt; Forbidden reference -&gt; Warning</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1-2-常用方法"><a href="#1-2-常用方法" class="headerlink" title="1.2 常用方法"></a>1.2 常用方法</h2><ul>
<li>Unsafe 的大部分 API 都是 native 的方法。</li>
</ul>
<h3 id="1-2-1-Class-相关"><a href="#1-2-1-Class-相关" class="headerlink" title="1.2.1 Class 相关"></a>1.2.1 Class 相关</h3><ul>
<li>主要提供 Class 和它的静态字段的操作方法。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//静态属性的偏移量，用于在对应的 Class 对象中读写静态属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">staticFieldOffset</span><span class="params">(Field f)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">staticFieldBase</span><span class="params">(Field f)</span>;</span><br><span class="line"><span class="comment">//判断是否需要初始化一个类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">shouldBeInitialized</span><span class="params">(Class c)</span>;</span><br><span class="line"><span class="comment">//确保类被初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">ensureClassInitialized</span><span class="params">(Class c)</span>;</span><br><span class="line"><span class="comment">//定义一个类，可用于动态创建类</span></span><br><span class="line"><span class="comment">// Tell the VM to define a class, without security checks.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class <span class="title function_">defineClass</span><span class="params">(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len, ClassLoader loader, ProtectionDomain protectionDomain)</span>;</span><br><span class="line"><span class="comment">//动态创建类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class <span class="title function_">defineClass</span><span class="params">(String var1, <span class="type">byte</span>[] var2, <span class="type">int</span> var3, <span class="type">int</span> var4)</span>;</span><br><span class="line"><span class="comment">//定义一个匿名类，可用于动态创建类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class <span class="title function_">defineAnonymousClass</span><span class="params">(Class hostClass, <span class="type">byte</span>[] data, Object[] cpPatches)</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-2-Object-相关"><a href="#1-2-2-Object-相关" class="headerlink" title="1.2.2 Object 相关"></a>1.2.2 Object 相关</h3><ul>
<li>Java 中的基本类型（boolean、byte、char、short、int、long、float、double）及对象引用类型都有以下方法。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得对象的字段偏移量</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">objectFieldOffset</span><span class="params">(Field f)</span>;</span><br><span class="line"><span class="comment">//获得给定对象地址偏移量的int值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getInt</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;</span><br><span class="line"><span class="comment">//设置给定对象地址偏移量的int值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> x)</span>;</span><br><span class="line"><span class="comment">//获得给定对象地址偏移量的值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObject</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;</span><br><span class="line"><span class="comment">//设置给定对象地址偏移量的值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object o, <span class="type">long</span> offset, Object x)</span>;</span><br><span class="line"><span class="comment">//创建对象，但并不会调用其构造方法。如果类未被初始化，将初始化类。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">allocateInstance</span><span class="params">(Class cls)</span> <span class="keyword">throws</span> InstantiationException;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-3-数组相关"><a href="#1-2-3-数组相关" class="headerlink" title="1.2.3 数组相关"></a>1.2.3 数组相关</h3><ul>
<li>通过 arrayBaseOffset 和 arrayIndexScale 可定位数组中每个元素在内存中的位置。   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回数组中第一个元素的偏移地址</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayBaseOffset</span><span class="params">(Class arrayClass)</span>;</span><br><span class="line"><span class="comment">//boolean、byte、short、char、int、long、float、double，及对象类型均有以下方法</span></span><br><span class="line"><span class="comment">/** The value of &#123;<span class="doctag">@code</span> arrayBaseOffset(boolean[].class)&#125; */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ARRAY_BOOLEAN_BASE_OFFSET</span> <span class="operator">=</span> theUnsafe.arrayBaseOffset(<span class="type">boolean</span>[].class);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Report the scale factor for addressing elements in the storage</span></span><br><span class="line"><span class="comment"> * allocation of a given array class. However, arrays of &quot;narrow&quot; types</span></span><br><span class="line"><span class="comment"> * will generally not work properly with accessors like &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * #getByte(Object, int)&#125;, so the scale factor for such classes is reported</span></span><br><span class="line"><span class="comment"> * as zero.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #arrayBaseOffset</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getInt(Object, long)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #putInt(Object, long, int)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//返回数组中每一个元素占用的大小</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayIndexScale</span><span class="params">(Class arrayClass)</span>;</span><br><span class="line"><span class="comment">//boolean、byte、short、char、int、long、float、double，及对象类型均有以下方法</span></span><br><span class="line"><span class="comment">/** The value of &#123;<span class="doctag">@code</span> arrayIndexScale(boolean[].class)&#125; */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ARRAY_BOOLEAN_INDEX_SCALE</span> <span class="operator">=</span> theUnsafe.arrayIndexScale(<span class="type">boolean</span>[].class);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-4-CAS-相关"><a href="#1-2-4-CAS-相关" class="headerlink" title="1.2.4 CAS 相关"></a>1.2.4 CAS 相关</h3><ul>
<li><p>compareAndSwap，内存偏移地址 offset，预期值 expected，新值 x。如果变量在当前时刻的值和预期值 expected 相等，尝试将变量的值更新为 x。如果更新成功，返回 true；否则，返回 false。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新变量值为x，如果当前值为expected</span></span><br><span class="line"><span class="comment">//o：对象 offset：偏移量 expected：期望值 x：新值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object o, <span class="type">long</span> offset, Object expected, Object x)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> expected, <span class="type">int</span> x)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapLong</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> expected, <span class="type">long</span> x)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JDK 1.8 中基于 CAS 扩展。</p>
<ul>
<li>作用都是，通过 CAS 设置新的值，返回旧的值。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//增加</span><br><span class="line">public final int getAndAddInt(Object o, long offset, int delta) &#123;</span><br><span class="line"> int v;</span><br><span class="line"> do &#123;</span><br><span class="line"> v = getIntVolatile(o, offset);</span><br><span class="line"> &#125; while (!compareAndSwapInt(o, offset, v, v + delta));</span><br><span class="line"> return v;</span><br><span class="line">&#125;</span><br><span class="line">public final long getAndAddLong(Object o, long offset, long delta) &#123;</span><br><span class="line"> long v;</span><br><span class="line"> do &#123;</span><br><span class="line"> v = getLongVolatile(o, offset);</span><br><span class="line"> &#125; while (!compareAndSwapLong(o, offset, v, v + delta));</span><br><span class="line"> return v;</span><br><span class="line">&#125;</span><br><span class="line">//设置</span><br><span class="line">public final int getAndSetInt(Object o, long offset, int newValue) &#123;</span><br><span class="line"> int v;</span><br><span class="line"> do &#123;</span><br><span class="line"> v = getIntVolatile(o, offset);</span><br><span class="line"> &#125; while (!compareAndSwapInt(o, offset, v, newValue));</span><br><span class="line"> return v;</span><br><span class="line">&#125;</span><br><span class="line">public final long getAndSetLong(Object o, long offset, long newValue) &#123;</span><br><span class="line"> long v;</span><br><span class="line"> do &#123;</span><br><span class="line"> v = getLongVolatile(o, offset);</span><br><span class="line"> &#125; while (!compareAndSwapLong(o, offset, v, newValue));</span><br><span class="line"> return v;</span><br><span class="line">&#125;</span><br><span class="line">public final Object getAndSetObject(Object o, long offset, Object newValue) &#123;</span><br><span class="line"> Object v;</span><br><span class="line"> do &#123;</span><br><span class="line"> v = getObjectVolatile(o, offset);</span><br><span class="line"> &#125; while (!compareAndSwapObject(o, offset, v, newValue));</span><br><span class="line"> return v;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="1-2-5-线程调度相关"><a href="#1-2-5-线程调度相关" class="headerlink" title="1.2.5 线程调度相关"></a>1.2.5 线程调度相关</h3><ul>
<li>主要包括监视器锁定、解锁等。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//取消阻塞线程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Object thread)</span>;</span><br><span class="line"><span class="comment">//阻塞线程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(<span class="type">boolean</span> isAbsolute, <span class="type">long</span> time)</span>;</span><br><span class="line"><span class="comment">//获得对象锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorEnter</span><span class="params">(Object o)</span>;</span><br><span class="line"><span class="comment">//释放对象锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorExit</span><span class="params">(Object o)</span>;</span><br><span class="line"><span class="comment">//尝试获取对象锁，返回 true 或 false 表示是否获取成功</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">tryMonitorEnter</span><span class="params">(Object o)</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-6-volatile-相关读写"><a href="#1-2-6-volatile-相关读写" class="headerlink" title="1.2.6 volatile 相关读写"></a>1.2.6 volatile 相关读写</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从对象的指定偏移量处获取变量的引用，使用 volatile 的加载语义</span></span><br><span class="line"><span class="comment">//相当于 getObject(Object, long) 的 volatile 版本</span></span><br><span class="line"><span class="comment">//从主存中获取值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObjectVolatile</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储变量的引用到对象的指定的偏移量处，使用 volatile 的存储语义</span></span><br><span class="line"><span class="comment">//相当于 putObject(Object, long, Object) 的 volatile 版本</span></span><br><span class="line"><span class="comment">//设置值刷新主存</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putObjectVolatile</span><span class="params">(Object o, <span class="type">long</span> offset, Object x)</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Version of &#123;<span class="doctag">@link</span> #putObjectVolatile(Object, long, Object)&#125;</span></span><br><span class="line"><span class="comment"> * that does not guarantee immediate visibility of the store to</span></span><br><span class="line"><span class="comment"> * other threads. This method is generally only useful if the</span></span><br><span class="line"><span class="comment"> * underlying field is a Java volatile (or if an array cell, one</span></span><br><span class="line"><span class="comment"> * that is otherwise only accessed using volatile accesses).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedObject</span><span class="params">(Object o, <span class="type">long</span> offset, Object x)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Ordered/Lazy version of &#123;<span class="doctag">@link</span> #putIntVolatile(Object, long, int)&#125; */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> x)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Ordered/Lazy version of &#123;<span class="doctag">@link</span> #putLongVolatile(Object, long, long)&#125; */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putOrderedLong</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> x)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-7-内存屏障相关"><a href="#1-2-7-内存屏障相关" class="headerlink" title="1.2.7 内存屏障相关"></a>1.2.7 内存屏障相关</h3><ul>
<li>JDK 1.8 引入 ，用于定义内存屏障，避免代码重排序。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内存屏障，禁止 load 操作重排序，即屏障前的load操作不能被重排序到屏障后，屏障后的 load 操作不能被重排序到屏障前</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">loadFence</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//内存屏障，禁止 store 操作重排序，即屏障前的 store 操作不能被重排序到屏障后，屏障后的 store 操作不能被重排序到屏障前</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">storeFence</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">//内存屏障，禁止 load、store 操作重排序</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">fullFence</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-8-内存管理（非堆内存）"><a href="#1-2-8-内存管理（非堆内存）" class="headerlink" title="1.2.8 内存管理（非堆内存）"></a>1.2.8 内存管理（<em><strong>非堆内存</strong></em>）</h3><ul>
<li>allocateMemory <strong>所分配的内存需要手动 free（不被 GC 回收）</strong><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//（boolean、byte、char、short、int、long、float、double) 都有以下 get、put 两个方法。</span></span><br><span class="line"><span class="comment">//获得给定地址上的 int 值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getInt</span><span class="params">(<span class="type">long</span> address)</span>;</span><br><span class="line"><span class="comment">//设置给定地址上的 int 值</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putInt</span><span class="params">(<span class="type">long</span> address, <span class="type">int</span> x)</span>;</span><br><span class="line"><span class="comment">//获得本地指针</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">getAddress</span><span class="params">(<span class="type">long</span> address)</span>;</span><br><span class="line"><span class="comment">//存储本地指针到给定的内存地址</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putAddress</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> x)</span>;</span><br><span class="line"><span class="comment">//分配内存</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">allocateMemory</span><span class="params">(<span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="comment">//重新分配内存</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">reallocateMemory</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="comment">//初始化内存内容</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">setMemory</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> bytes, <span class="type">byte</span> value)</span>;</span><br><span class="line"><span class="comment">//初始化内存内容</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMemory</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> bytes, <span class="type">byte</span> value)</span> &#123;</span><br><span class="line"> setMemory(<span class="literal">null</span>, address, bytes, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//内存内容拷贝</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">copyMemory</span><span class="params">(Object srcBase, <span class="type">long</span> srcOffset, Object destBase, <span class="type">long</span> destOffset, <span class="type">long</span> bytes)</span>;</span><br><span class="line"><span class="comment">//内存内容拷贝</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyMemory</span><span class="params">(<span class="type">long</span> srcAddress, <span class="type">long</span> destAddress, <span class="type">long</span> bytes)</span> &#123;</span><br><span class="line"> copyMemory(<span class="literal">null</span>, srcAddress, <span class="literal">null</span>, destAddress, bytes);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//释放内存</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">freeMemory</span><span class="params">(<span class="type">long</span> address)</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-9-系统相关"><a href="#1-2-9-系统相关" class="headerlink" title="1.2.9 系统相关"></a>1.2.9 系统相关</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回指针的大小。返回值为 4 或 8。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">addressSize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The value of &#123;<span class="doctag">@code</span> addressSize()&#125; */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ADDRESS_SIZE</span> <span class="operator">=</span> theUnsafe.addressSize();</span><br><span class="line"></span><br><span class="line"><span class="comment">//内存页的大小。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-10-其他"><a href="#1-2-10-其他" class="headerlink" title="1.2.10 其他"></a>1.2.10 其他</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取系统的平均负载值，loadavg 这个 double 数组将会存放负载值的结果，nelems 决定样本数量，nelems 只能取值为 1 到 3，分别代表最近 1、5、15 分钟内系统的平均负载。</span></span><br><span class="line"><span class="comment">//如果无法获取系统的负载，此方法返回 -1，否则返回获取到的样本数量（loadavg 中有效的元素个数）。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getLoadAverage</span><span class="params">(<span class="type">double</span>[] loadavg, <span class="type">int</span> nelems)</span>;</span><br><span class="line"><span class="comment">//绕过检测机制直接抛出异常。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">throwException</span><span class="params">(Throwable ee)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="1-3-Unsafe-类的使用场景"><a href="#1-3-Unsafe-类的使用场景" class="headerlink" title="1.3 Unsafe 类的使用场景"></a>1.3 Unsafe 类的使用场景</h2><h3 id="1-3-1-避免初始化"><a href="#1-3-1-避免初始化" class="headerlink" title="1.3.1 避免初始化"></a>1.3.1 避免初始化</h3><ul>
<li><p><em><strong>当想要绕过对象构造方法、安全检查器或者没有 public 的构造方法时，allocateInstance() 方法变得非常有用。</strong></em></p>
</li>
<li><p>编写一个简单的 Java 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestA</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestA</span><span class="params">()</span> &#123;</span><br><span class="line">        a = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>构造方法、反射方法和 allocateInstance 方法的不同实现。</p>
<ul>
<li><em><strong>将 public 构造方法修改为 private，allocateInstance 方法可以得到同样的结果。</strong></em><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// constructor</span></span><br><span class="line"><span class="type">TestA</span> <span class="variable">constructorA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestA</span>();</span><br><span class="line">System.out.println(constructorA.getA()); <span class="comment">//print 1</span></span><br><span class="line"><span class="comment">// reflection</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="type">TestA</span> <span class="variable">reflectionA</span> <span class="operator">=</span> TestA.class.newInstance();</span><br><span class="line">     System.out.println(reflectionA.getA()); <span class="comment">//print 1</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">     e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">     e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// unsafe</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">     f = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">     f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">     <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">     <span class="type">TestA</span> <span class="variable">unsafeA</span> <span class="operator">=</span> (TestA) unsafe.allocateInstance(TestA.class);</span><br><span class="line">     System.out.println(unsafeA.getA()); <span class="comment">//print 0</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">     e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">     e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">     e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="1-3-2-内存修改"><a href="#1-3-2-内存修改" class="headerlink" title="1.3.2 内存修改"></a>1.3.2 内存修改</h3><ul>
<li><p>Unsafe 可用于绕过安全的常用技术，直接修改内存变量。</p>
<ul>
<li>反射也可以实现相同的功能。但是 Unsafe 可以修改任何对象，甚至没有这些对象的引用。</li>
</ul>
</li>
<li><p>编写一个简单的 Java 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestA</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">ACCESS_ALLOWED</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">giveAccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">40</span> == ACCESS_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在正常情况下，giveAccess 总会返回 false。</p>
<ul>
<li>通过计算内存偏移，并使用 putInt() 方法，类的 ACCESS_ALLOWED 被修改。</li>
<li>在已知类结构的时候，数据的偏移总是可以计算出来（与 c++ 中的类中数据的偏移计算是一致的）。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// constructor</span></span><br><span class="line"><span class="type">TestA</span> <span class="variable">constructorA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestA</span>();</span><br><span class="line">System.out.println(constructorA.giveAccess()); <span class="comment">//print false</span></span><br><span class="line"><span class="comment">// unsafe</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    f = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">    <span class="type">TestA</span> <span class="variable">unsafeA</span> <span class="operator">=</span> (TestA) unsafe.allocateInstance(TestA.class);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">unsafeAField</span> <span class="operator">=</span> unsafeA.getClass().getDeclaredField(<span class="string">&quot;ACCESS_ALLOWED&quot;</span>);</span><br><span class="line">    unsafe.putInt(unsafeA, unsafe.objectFieldOffset(unsafeAField), <span class="number">40</span>); <span class="comment">// memory corruption</span></span><br><span class="line">    System.out.println(unsafeA.giveAccess()); <span class="comment">//print true</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="1-3-3-动态类"><a href="#1-3-3-动态类" class="headerlink" title="1.3.3 动态类"></a>1.3.3 动态类</h3><ul>
<li><p>可以在运行时创建一个类，比如从已编译的 .class 文件中将类内容读取为字节数组，并正确地传递给 defineClass 方法。</p>
<ul>
<li>当必须动态创建类，而现有代码中有一些代理，这非常有用。</li>
</ul>
</li>
<li><p>编写一个简单的 Java 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestA</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setA</span><span class="params">(<span class="type">int</span> a)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.a = a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态创建类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] classContents = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">      classContents = getClassContent();</span><br><span class="line">      <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> getUnsafe().defineClass(<span class="string">&quot;com.me.TestA&quot;</span>, classContents, <span class="number">0</span>, classContents.length);</span><br><span class="line">      System.out.println(c.getMethod(<span class="string">&quot;getA&quot;</span>).invoke(c.newInstance(), <span class="literal">null</span>)); <span class="comment">//print 1</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getClassContent() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;/home/test/TestA.class&quot;</span>);</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(f);</span><br><span class="line">        <span class="type">byte</span>[] content = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) f.length()];</span><br><span class="line">        input.read(content);</span><br><span class="line">        input.close();</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-3-4-大数组"><a href="#1-3-4-大数组" class="headerlink" title="1.3.4 大数组"></a>1.3.4 大数组</h3><ul>
<li><p>Java 数组大小的最大值为 Integer.MAX_VALUE。使用直接内存分配，创建的数组大小受限于堆大小。</p>
</li>
<li><p><em><strong>Unsafe 分配的内存，分配在非堆内存，因为不执行任何边界检查，所以任何非法访问都可能会导致 JVM 崩溃。</strong></em></p>
<ul>
<li>在需要分配大的连续区域、实时编程（不能容忍 JVM 延迟）时，可以使用它。java.nio 使用这一技术。</li>
</ul>
</li>
<li><p>创建一个 Java 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuperArray</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">BYTE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> address;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SuperArray</span><span class="params">(<span class="type">long</span> size)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.size = size;</span><br><span class="line">        address = getUnsafe().allocateMemory(size * BYTE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(<span class="type">long</span> i, <span class="type">byte</span> value)</span> &#123;</span><br><span class="line">        getUnsafe().putByte(address + i * BYTE, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">(<span class="type">long</span> idx)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getUnsafe().getByte(address + idx * BYTE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用大数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">SUPER_SIZE</span> <span class="operator">=</span> (<span class="type">long</span>) Integer.MAX_VALUE * <span class="number">2</span>;</span><br><span class="line"><span class="type">SuperArray</span> <span class="variable">array</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SuperArray</span>(SUPER_SIZE);</span><br><span class="line">System.out.println(<span class="string">&quot;Array size:&quot;</span> + array.size()); <span class="comment">//print 4294967294</span></span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">     array.set((<span class="type">long</span>) Integer.MAX_VALUE + i, (<span class="type">byte</span>) <span class="number">3</span>);</span><br><span class="line">     sum += array.get((<span class="type">long</span>) Integer.MAX_VALUE + i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;Sum of 100 elements:&quot;</span> + sum);  <span class="comment">//print 300</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-3-5-并发应用"><a href="#1-3-5-并发应用" class="headerlink" title="1.3.5 并发应用"></a>1.3.5 并发应用</h3><ul>
<li><p><strong>compareAndSwap</strong> 方法是原子的，并且可用来实现高性能的、无锁的数据结构。</p>
</li>
<li><p>创建一个 Java 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CASCounter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Unsafe unsafe;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> offset;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CASCounter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        unsafe = getUnsafe();</span><br><span class="line">        offset = unsafe.objectFieldOffset(CASCounter.class.getDeclaredField(<span class="string">&quot;counter&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">before</span> <span class="operator">=</span> counter;</span><br><span class="line">        <span class="keyword">while</span> (!unsafe.compareAndSwapLong(<span class="built_in">this</span>, offset, before, before + <span class="number">1</span>)) &#123;</span><br><span class="line">            before = counter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> counter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用无锁的数据结构。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">TestB</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestB</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                b.counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                b.counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                b.counter.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        threadA.start();</span><br><span class="line">        threadB.start();</span><br><span class="line">        threadC.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(b.counter.getCounter()); <span class="comment">//print 3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TestB</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> CASCounter counter;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TestB</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                counter = <span class="keyword">new</span> <span class="title class_">CASCounter</span>();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-3-6-挂起与恢复"><a href="#1-3-6-挂起与恢复" class="headerlink" title="1.3.6 挂起与恢复"></a>1.3.6 <em><strong>挂起与恢复</strong></em></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Thread jthread)</span>;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(<span class="type">boolean</span> isAbsolute, <span class="type">long</span> time)</span>; <span class="comment">// isAbsolute 参数是指明时间是绝对的，还是相对的。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>将一个线程进行挂起是通过 park 方法实现，调用 park 后，线程将一直阻塞直到超时或者中断等条件出现。</li>
<li>unpark 可以终止一个挂起的线程，使其恢复正常。<ul>
<li>整个并发框架中对线程的挂起操作被封装在 LockSupport 类中，LockSupport 类中有各种版本 pack 方法，但最终都调用的 Unsafe.park() 方法。</li>
</ul>
</li>
<li>unpark 函数为线程提供 “ 许可（permit）”，线程调用 park 函数则等待 “ 许可 “。<ul>
<li>这个有点像信号量，但是这个 “ 许可 “ 不能叠加，是一次性的。<ul>
<li>比如线程 B 连续调用了三次 unpark 函数，当线程 A 调用 park 函数就使用掉这个 “ 许可 “，如果线程 A 再次调用 park，则进入等待状态。</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">currThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">getUnsafe().unpark(currThread);</span><br><span class="line">getUnsafe().unpark(currThread);</span><br><span class="line">getUnsafe().unpark(currThread);</span><br><span class="line"></span><br><span class="line">getUnsafe().park(<span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">getUnsafe().park(<span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;execute success&quot;</span>); <span class="comment">// 线程挂起，不会打印。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>unpark 函数可以先于 park 调用（但最好别这样做），比如线程 B 调用 unpark 函数，给线程 A 发了一个 “ 许可 “，那么当线程 A 调用 park 时，发现已经有 “ 许可 “，会马上再继续运行。</li>
<li>park 遇到线程终止时，会直接返回（不同于 Thread.sleep，Thread.sleep 遇到 thread.interrupt() 会抛异常）。</li>
<li>unpark 无法恢复处于 sleep 中的线程，只能与 park 配对使用，因为 unpark 发放的许可只有 park 能监听到。</li>
</ul>
<h4 id="1-3-6-1-park-和-unpark-灵活之处"><a href="#1-3-6-1-park-和-unpark-灵活之处" class="headerlink" title="1.3.6.1 park 和 unpark 灵活之处"></a>1.3.6.1 park 和 unpark 灵活之处</h4><ul>
<li>因为 park 的特性，可以不用担心 park 的时序问题。</li>
<li>park &#x2F; unpark 模型真正解耦了线程之间的同步，线程之间不再需要一个 Object 或者其它变量来存储状态，不再需要关心对方的状态。</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/140726.htm">https://www.jb51.net/article/140726.htm</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/luoyoub/article/details/79918104">https://blog.csdn.net/luoyoub/article/details/79918104</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/suxuan/p/4948608.html">https://www.cnblogs.com/suxuan/p/4948608.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/throwable/p/9139947.html">https://www.cnblogs.com/throwable/p/9139947.html</a></p>

      </div>
      
      
      
    </div>

    
    


    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  <span class="with-love">
    <i class="fa fa-pen"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WEN</span>
  <b>&nbsp;&nbsp;&nbsp;Keep fighting !&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>
  <!--
  &copy; 
  <span itemprop="copyrightYear">2023</span> -->
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line">&nbsp;字数:</i>
    </span>
    <span title="站点总字数">129k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee">&nbsp;阅读时长:</i>
    </span>
    <span title="站点阅读时长">7:51</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user">&nbsp;总访客量:</i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye">&nbsp;总访问量:</i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="49" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/guanyuespace" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":false,"archive":false,"delay":true,"timeout":3000,"priority":true,"url":"https://xuewenm.github.io/interest/Unsafe.html"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"xuewenm","repo":"Comments","client_id":"277afed5e192963a5025","client_secret":"f1b813c1d9382088b20d4590765a56c68f14209b","admin_user":"xuewenm","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"b00eede8f042d8fa7a8345668b8db91e"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
